//------------------------------------------------------------------------------
//   Warning: This code was automatically generated.
//   Changes to this file may cause incorrect behavior
//   and will be lost when this file is regenerated.
//------------------------------------------------------------------------------
//
// |metacode:version=0.1|
// |metacode:generator_header|
using System;
using System.Linq;
using MetaFac.CG4.Generators;
using MetaFac.CG4.Models;
namespace MetaFac.CG4.Generator.MessagePack
{
    public partial class Generator : GeneratorBase
    {
        public Generator() : base("MetaFac.CG4.MessagePack") { }
        protected override void OnGenerate(ModelDefinition outerScope)
        {
// |metacode:generator_body|
Define("BooleanFieldType", "Boolean");
Define("SByteFieldType", "SByte");
Define("ByteFieldType", "Byte");
Define("Int16FieldType", "Int16");
Define("UInt16FieldType", "UInt16");
Define("CharFieldType", "Char");
Define("Int32FieldType", "Int32");
Define("UInt32FieldType", "UInt32");
Define("SingleFieldType", "Single");
Define("Int64FieldType", "Int64");
Define("UInt64FieldType", "UInt64");
Define("DoubleFieldType", "Double");
Define("DateTimeFieldType", "DateTime");
Define("TimeSpanFieldType", "TimeSpan");
Define("DateTimeZoneFieldType", "DateTimeOffset");
Define("DecimalFieldType", "Decimal");
Define("GuidFieldType", "Guid");
Define("ConcreteBoolean", "T_BooleanFieldType_");
Define("ConcreteSByte", "T_SByteFieldType_");
Define("ConcreteByte", "T_ByteFieldType_");
Define("ConcreteInt16", "T_Int16FieldType_");
Define("ConcreteUInt16", "T_UInt16FieldType_");
Define("ConcreteChar", "T_CharFieldType_");
Define("ConcreteInt32", "T_Int32FieldType_");
Define("ConcreteUInt32", "T_UInt32FieldType_");
Define("ConcreteSingle", "T_SingleFieldType_");
Define("ConcreteInt64", "T_Int64FieldType_");
Define("ConcreteUInt64", "T_UInt64FieldType_");
Define("ConcreteDouble", "T_DoubleFieldType_");
Define("ConcreteDateTime", "T_DateTimeFieldType_");
Define("ConcreteTimeSpan", "T_TimeSpanFieldType_");
Define("ConcreteDateTimeOffset", "T_DateTimeZoneFieldType_");
Define("ConcreteDecimal", "T_DecimalFieldType_");
Define("ConcreteGuid", "T_GuidFieldType_");
Define("ExternalBoolean", "T_BooleanFieldType_");
Define("ExternalSByte", "T_SByteFieldType_");
Define("ExternalByte", "T_ByteFieldType_");
Define("ExternalInt16", "T_Int16FieldType_");
Define("ExternalUInt16", "T_UInt16FieldType_");
Define("ExternalChar", "T_CharFieldType_");
Define("ExternalInt32", "T_Int32FieldType_");
Define("ExternalUInt32", "T_UInt32FieldType_");
Define("ExternalSingle", "T_SingleFieldType_");
Define("ExternalInt64", "T_Int64FieldType_");
Define("ExternalUInt64", "T_UInt64FieldType_");
Define("ExternalDouble", "T_DoubleFieldType_");
Define("ExternalDateTime", "T_DateTimeFieldType_");
Define("ExternalTimeSpan", "T_TimeSpanFieldType_");
Define("ExternalDateTimeOffset", "T_DateTimeZoneFieldType_");
Define("ExternalDecimal", "T_DecimalFieldType_");
Define("ExternalGuid", "T_GuidFieldType_");
Define("ConcreteDateTime", "DateTimeValue");
Define("ExternalDateTime", "DateTime");
Define("ConcreteDateTimeOffset", "DateTimeOffsetValue");
Define("ExternalDateTimeOffset", "DateTimeOffset");
Define("ConcreteDecimal", "DecimalValue");
Define("ExternalDecimal", "Decimal");
Define("ConcreteGuid", "GuidValue");
Define("ExternalGuid", "Guid");
Define("ParentName", "EntityBase");
Emit("// <auto-generated />");
Emit("#region Auto-generated");
Emit("//--------------------------------------------------------------------------------");
Emit("// Warning: This file was automatically generated. Changes to this file may");
Emit("// cause incorrect behavior and will be lost when this file is regenerated.");
Emit("//");
Emit("// This file was generated using MetaFac.CG4 tools and user supplied metadata.");
Emit("//");
Emit("// To download and install the tool, the .NET CLI command is:");
Emit("// dotnet tool install --global MetaFac.CG4.CLI");
Emit("//");
Emit("// For more information about using this tool, the help command is:");
Emit("// mfcg4 g2c --help");
Emit("//--------------------------------------------------------------------------------");
Emit("#endregion");
Emit("#nullable enable");
Emit("using MetaFac.Memory;");
Emit("using MetaFac.Mutability;");
Emit("using MessagePack;");
Emit("using MetaFac.CG4.Runtime;");
Emit("using MetaFac.CG4.Runtime.MessagePack;");
Emit("using System;");
Emit("using System.Collections.Generic;");
Emit("using System.Collections.Immutable;");
Emit("using System.Linq;");
Emit("using System.Runtime.CompilerServices;");
Emit("using T_Namespace_.Contracts;");
Emit("");
Emit("namespace T_Namespace_.MessagePack");
Emit("{");
    using (Ignored())
    {
Emit("    using T_ConcreteOtherType_ = System.Int64;");
Emit("    using T_ExternalOtherType_ = System.Int64;");
Emit("    using T_IndexType_ = System.String;");
    }
Emit("");
    using (Ignored())
    {
Emit("    [MessagePackObject]");
Emit("    public class T_ModelType_ : EntityBase, IT_ModelType_, IEquatable<T_ModelType_>");
Emit("    {");
Emit("        public static T_ModelType_? CreateFrom(IT_ModelType_? source)");
Emit("        {");
Emit("            if (source is null) return null;");
Emit("            return new T_ModelType_(source);");
Emit("        }");
Emit("");
Emit("        protected override int OnGetEntityTag() => 0;");
Emit("");
Emit("        [Key(1)]");
Emit("        public int TestData { get; set; }");
Emit("");
Emit("        public T_ModelType_() { }");
Emit("        public T_ModelType_(int testData)");
Emit("        {");
Emit("            TestData = testData;");
Emit("        }");
Emit("        public T_ModelType_(IT_ModelType_? source)");
Emit("        {");
Emit("            if (source is null) throw new ArgumentNullException(nameof(source));");
Emit("            TestData = source.TestData;");
Emit("        }");
Emit("        public bool Equals(T_ModelType_? other)");
Emit("        {");
Emit("            if (ReferenceEquals(other, this)) return true;");
Emit("            if (other is null) return false;");
Emit("            return other.TestData == TestData;");
Emit("        }");
Emit("");
Emit("        public override bool Equals(object? obj)");
Emit("        {");
Emit("            return (obj is T_ModelType_ other) && Equals(other);");
Emit("        }");
Emit("");
Emit("        public override int GetHashCode()");
Emit("        {");
Emit("            return TestData.GetHashCode();");
Emit("        }");
Emit("    }");
Emit("");
Emit("    internal static class ConversionHelpers");
Emit("    {");
Emit("        public static T ToExternal<T>(this T value) => value;");
Emit("        public static T ToInternal<T>(this T value) => value;");
Emit("    }");
    }
Emit("");
Emit("    public abstract class EntityBase : IFreezable, IEntityBase, IEquatable<EntityBase>, ICopyFrom<EntityBase>");
Emit("    {");
Emit("        public static EntityBase Empty => throw new NotSupportedException();");
Emit("        public const int EntityTag = 0;");
Emit("");
Emit("        [MethodImpl(MethodImplOptions.NoInlining)]");
Emit("        private static void ThrowIsReadonly()");
Emit("        {");
Emit("            throw new InvalidOperationException(\"Cannot set properties when frozen\");");
Emit("        }");
Emit("");
Emit("        [MethodImpl(MethodImplOptions.AggressiveInlining)]");
Emit("        protected ref T CheckNotFrozen<T>(ref T value)");
Emit("        {");
Emit("            if (_isFrozen) ThrowIsReadonly();");
Emit("            return ref value;");
Emit("        }");
Emit("");
Emit("        [MethodImpl(MethodImplOptions.AggressiveInlining)]");
Emit("        protected void CheckNotFrozen()");
Emit("        {");
Emit("            if (_isFrozen) ThrowIsReadonly();");
Emit("        }");
Emit("");
Emit("        public EntityBase() { }");
Emit("        public EntityBase(EntityBase source) { }");
Emit("        public void CopyFrom(EntityBase source)");
Emit("        {");
Emit("            CheckNotFrozen();");
Emit("        }");
Emit("        public EntityBase(IEntityBase source) { }");
Emit("        protected abstract int OnGetEntityTag();");
Emit("        public int GetEntityTag() => OnGetEntityTag();");
Emit("");
Emit("        protected volatile bool _isFrozen = false;");
Emit("        public bool IsFreezable() => true;");
Emit("        public bool IsFrozen() => _isFrozen;");
Emit("        protected virtual void OnFreeze() { }");
Emit("        public void Freeze()");
Emit("        {");
Emit("            if (_isFrozen) return;");
Emit("            OnFreeze();");
Emit("            _isFrozen = true;");
Emit("        }");
Emit("        public bool TryFreeze()");
Emit("        {");
Emit("            if (_isFrozen) return false;");
Emit("            OnFreeze();");
Emit("            _isFrozen = true;");
Emit("            return true;");
Emit("        }");
Emit("");
Emit("        public bool Equals(EntityBase? other) => true;");
Emit("        public override bool Equals(object? obj) => obj is EntityBase other && this.Equals(other);");
Emit("        public override int GetHashCode() => 0;");
Emit("    }");
Emit("");
    using (Ignored())
    {
Emit("    [MessagePackObject]");
Emit("    public class T_ParentName_ : EntityBase, IT_ParentName_, IEquatable<T_ParentName_>, ICopyFrom<T_ParentName_>");
Emit("    {");
Emit("        [Key(1)]");
Emit("        public int ParentField1 { get; set; }");
Emit("        public T_ParentName_() { }");
Emit("        public T_ParentName_(T_ParentName_ source) : base(source) { }");
Emit("        public void CopyFrom(T_ParentName_ source) { }");
Emit("        public T_ParentName_(IT_ParentName_ source) : base(source) { }");
Emit("        public new const int EntityTag = 999;");
Emit("        protected override int OnGetEntityTag() => EntityTag;");
Emit("        public bool Equals(T_ParentName_? other)");
Emit("        {");
Emit("            if (other is null) return false;");
Emit("            if (ReferenceEquals(other, this)) return true;");
Emit("            return base.Equals(other);");
Emit("        }");
Emit("        public override bool Equals(object? obj) => obj is T_ParentName_ other && this.Equals(other);");
Emit("        public override int GetHashCode() => 0;");
Emit("");
Emit("        private static readonly T_ParentName_ _empty = new T_ParentName_();");
Emit("        public static new T_ParentName_ Empty => _empty;");
Emit("");
Emit("    }");
    }
Emit("");
    foreach (var cd in outerScope.EntityDefs)
    {
        using (NewScope(cd))
        {
            var derivedEntities = cd.DerivedEntities;
            if (derivedEntities.Count > 0)
            {
                foreach (var derived in derivedEntities)
                {
                    using (NewScope(derived))
                    {
Emit("    [Union(T_EntityName_.EntityTag, typeof(T_EntityName_))]");
                    }
                }
Emit("    public abstract partial class T_EntityName2_");
Emit("    {");
Emit("        [MethodImpl(MethodImplOptions.AggressiveInlining)]");
Emit("        public static T_EntityName_? CreateFrom(IT_EntityName_? source)");
Emit("        {");
Emit("            if (source is null) return null;");
Emit("            int entityTag = source.GetEntityTag();");
Emit("            switch (entityTag)");
Emit("            {");
                            foreach (var derived in derivedEntities)
                            {
                                using (NewScope(derived))
                                {
Emit("                case T_EntityName_.EntityTag: return T_EntityName_.CreateFrom((IT_EntityName_)source);");
                                }
                            }
Emit("                default:");
Emit("                    throw new ArgumentOutOfRangeException(nameof(entityTag), entityTag, null);");
Emit("            }");
Emit("        }");
Emit("    }");
            }
            else
            {
Emit("    public partial class T_EntityName_");
Emit("    {");
Emit("        [MethodImpl(MethodImplOptions.AggressiveInlining)]");
Emit("        public static T_EntityName_? CreateFrom(IT_EntityName_? source)");
Emit("        {");
Emit("            if (source is null) return null;");
Emit("            return new T_EntityName_(source);");
Emit("        }");
Emit("");
Emit("        private static T_EntityName_ CreateEmpty()");
Emit("        {");
Emit("            var empty = new T_EntityName_();");
Emit("            empty.Freeze();");
Emit("            return empty;");
Emit("        }");
Emit("        private static readonly T_EntityName_ _empty = CreateEmpty();");
Emit("        public static new T_EntityName_ Empty => _empty;");
Emit("");
Emit("    }");
            }
Emit("    [MessagePackObject]");
Emit("    public partial class T_EntityName_ : T_ParentName_, IT_EntityName_, IEquatable<T_EntityName_>, ICopyFrom<T_EntityName_>");
Emit("    {");
Emit("        protected override void OnFreeze()");
Emit("        {");
                    foreach (var fd in cd.FieldDefs)
                    {
                        using (NewScope(fd))
                        {
                            var fieldInfo = new FieldInfo(fd, _engine.Current);
                            switch (fieldInfo.Kind)
                            {
                                case FieldKind.UnaryModel:
Emit("            field_T_UnaryModelFieldName_?.Freeze();");
                                    break;
                                case FieldKind.ArrayModel:
Emit("            if (!(field_T_ArrayModelFieldName_ is null))");
Emit("            {");
Emit("                foreach (var element in field_T_ArrayModelFieldName_)");
Emit("                {");
Emit("                    element?.Freeze();");
Emit("                }");
Emit("            }");
                                    break;
                                case FieldKind.IndexModel:
Emit("            if (!(field_T_IndexModelFieldName_ is null))");
Emit("            {");
Emit("                foreach (var element in field_T_IndexModelFieldName_.Values)");
Emit("                {");
Emit("                    element?.Freeze();");
Emit("                }");
Emit("            }");
                                    break;
                                default: break;
                            }
                        }
                    }
Emit("            base.OnFreeze();");
Emit("        }");
Emit("");
                using (Ignored())
                {
Emit("        private const int T_EntityTag_ = 9000;");
Emit("        private const int T_FieldTag_ = 100;");
                }
Emit("        public new const int EntityTag = T_EntityTag_;");
Emit("        protected override int OnGetEntityTag() => EntityTag;");
Emit("");
Emit("        // ---------- private fields ----------");
                foreach (var fd in cd.FieldDefs)
                {
                    using (NewScope(fd))
                    {
                        var fieldInfo = new FieldInfo(fd, _engine.Current);
                        switch (fieldInfo.Kind)
                        {
                            case FieldKind.UnaryModel:
Emit("        private T_ModelType_? field_T_UnaryModelFieldName_;");
                                break;
                            case FieldKind.ArrayModel:
Emit("        private ImmutableList<T_ModelType_?>? field_T_ArrayModelFieldName_;");
                                break;
                            case FieldKind.IndexModel:
Emit("        private ImmutableDictionary<T_IndexType_, T_ModelType_?>? field_T_IndexModelFieldName_;");
                                break;
                            case FieldKind.UnaryMaybe:
Emit("        private T_ConcreteOtherType_? field_T_UnaryMaybeFieldName_;");
                                break;
                            case FieldKind.ArrayMaybe:
Emit("        private ImmutableList<T_ConcreteOtherType_?>? field_T_ArrayMaybeFieldName_;");
                                break;
                            case FieldKind.IndexMaybe:
Emit("        private ImmutableDictionary<T_IndexType_, T_ConcreteOtherType_?>? field_T_IndexMaybeFieldName_;");
                                break;
                            case FieldKind.UnaryOther:
Emit("        private T_ConcreteOtherType_ field_T_UnaryOtherFieldName_;");
                                break;
                            case FieldKind.ArrayOther:
Emit("        private ImmutableList<T_ConcreteOtherType_>? field_T_ArrayOtherFieldName_;");
                                break;
                            case FieldKind.IndexOther:
Emit("        private ImmutableDictionary<T_IndexType_, T_ConcreteOtherType_>? field_T_IndexOtherFieldName_;");
                                break;
                            case FieldKind.UnaryBuffer:
Emit("        private BinaryValue? field_T_UnaryBufferFieldName_;");
                                break;
                            case FieldKind.ArrayBuffer:
Emit("        private ImmutableList<BinaryValue?>? field_T_ArrayBufferFieldName_;");
                                break;
                            case FieldKind.IndexBuffer:
Emit("        private ImmutableDictionary<T_IndexType_, BinaryValue?>? field_T_IndexBufferFieldName_;");
                                break;
                            case FieldKind.UnaryString:
Emit("        private String? field_T_UnaryStringFieldName_;");
                                break;
                            case FieldKind.ArrayString:
Emit("        private ImmutableList<String?>? field_T_ArrayStringFieldName_;");
                                break;
                            case FieldKind.IndexString:
Emit("        private ImmutableDictionary<T_IndexType_, String?>? field_T_IndexStringFieldName_;");
                                break;
                            default:
                                throw new ArgumentOutOfRangeException("fieldInfo.Kind", fieldInfo.Kind, $"ordinal={(int)fieldInfo.Kind}");
                        }
                    }
                }
Emit("");
Emit("        // ---------- accessors ----------");
                foreach (var fd in cd.FieldDefs)
                {
                    using (NewScope(fd))
                    {
                        var fieldInfo = new FieldInfo(fd, _engine.Current);
Emit("        [Key(T_FieldTag_)]");
                        using (Ignored())
                        {
Emit("        public int IgnoreThisField { get; set; }");
                        }
                        switch (fieldInfo.Kind)
                        {
                            case FieldKind.UnaryModel:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 1)]");
                                }
Emit("        public T_ModelType_? T_UnaryModelFieldName_");
Emit("        {");
Emit("            get => field_T_UnaryModelFieldName_;");
Emit("            set => field_T_UnaryModelFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.ArrayModel:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 2)]");
                                }
Emit("        public ImmutableList<T_ModelType_?>? T_ArrayModelFieldName_");
Emit("        {");
Emit("            get => field_T_ArrayModelFieldName_;");
Emit("            set => field_T_ArrayModelFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.IndexModel:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 3)]");
                                }
Emit("        public ImmutableDictionary<T_IndexType_, T_ModelType_?>? T_IndexModelFieldName_");
Emit("        {");
Emit("            get => field_T_IndexModelFieldName_;");
Emit("            set => field_T_IndexModelFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.UnaryMaybe:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 4)]");
                                }
Emit("        public T_ConcreteOtherType_? T_UnaryMaybeFieldName_");
Emit("        {");
Emit("            get => field_T_UnaryMaybeFieldName_;");
Emit("            set => field_T_UnaryMaybeFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.ArrayMaybe:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 5)]");
                                }
Emit("        public ImmutableList<T_ConcreteOtherType_?>? T_ArrayMaybeFieldName_");
Emit("        {");
Emit("            get => field_T_ArrayMaybeFieldName_;");
Emit("            set => field_T_ArrayMaybeFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.IndexMaybe:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 6)]");
                                }
Emit("        public ImmutableDictionary<T_IndexType_, T_ConcreteOtherType_?>? T_IndexMaybeFieldName_");
Emit("        {");
Emit("            get => field_T_IndexMaybeFieldName_;");
Emit("            set => field_T_IndexMaybeFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.UnaryOther:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 7)]");
                                }
Emit("        public T_ConcreteOtherType_ T_UnaryOtherFieldName_");
Emit("        {");
Emit("            get => field_T_UnaryOtherFieldName_;");
Emit("            set => field_T_UnaryOtherFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.ArrayOther:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 8)]");
                                }
Emit("        public ImmutableList<T_ConcreteOtherType_>? T_ArrayOtherFieldName_");
Emit("        {");
Emit("            get => field_T_ArrayOtherFieldName_;");
Emit("            set => field_T_ArrayOtherFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.IndexOther:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 9)]");
                                }
Emit("        public ImmutableDictionary<T_IndexType_, T_ConcreteOtherType_>? T_IndexOtherFieldName_");
Emit("        {");
Emit("            get => field_T_IndexOtherFieldName_;");
Emit("            set => field_T_IndexOtherFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.UnaryBuffer:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 10)]");
                                }
Emit("        public BinaryValue? T_UnaryBufferFieldName_");
Emit("        {");
Emit("            get => field_T_UnaryBufferFieldName_;");
Emit("            set => field_T_UnaryBufferFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.ArrayBuffer:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 11)]");
                                }
Emit("        public ImmutableList<BinaryValue?>? T_ArrayBufferFieldName_");
Emit("        {");
Emit("            get => field_T_ArrayBufferFieldName_;");
Emit("            set => field_T_ArrayBufferFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.IndexBuffer:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 12)]");
                                }
Emit("        public ImmutableDictionary<T_IndexType_, BinaryValue?>? T_IndexBufferFieldName_");
Emit("        {");
Emit("            get => field_T_IndexBufferFieldName_;");
Emit("            set => field_T_IndexBufferFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.UnaryString:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 13)]");
                                }
Emit("        public String? T_UnaryStringFieldName_");
Emit("        {");
Emit("            get => field_T_UnaryStringFieldName_;");
Emit("            set => field_T_UnaryStringFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.ArrayString:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 14)]");
                                }
Emit("        public ImmutableList<String?>? T_ArrayStringFieldName_");
Emit("        {");
Emit("            get => field_T_ArrayStringFieldName_;");
Emit("            set => field_T_ArrayStringFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            case FieldKind.IndexString:
                                using (Ignored())
                                {
Emit("        [Key(T_FieldTag_ + 15)]");
                                }
Emit("        public ImmutableDictionary<T_IndexType_, String?>? T_IndexStringFieldName_");
Emit("        {");
Emit("            get => field_T_IndexStringFieldName_;");
Emit("            set => field_T_IndexStringFieldName_ = CheckNotFrozen(ref value);");
Emit("        }");
                                break;
                            default:
                                throw new ArgumentOutOfRangeException("fieldInfo.Kind", fieldInfo.Kind, $"ordinal={(int)fieldInfo.Kind}");
                        }
                    }
                }
Emit("");
Emit("        // ---------- IT_EntityName_ methods ----------");
                foreach (var fd in cd.FieldDefs)
                {
                    using (NewScope(fd))
                    {
                        var fieldInfo = new FieldInfo(fd, _engine.Current);
                        switch (fieldInfo.Kind)
                        {
                            case FieldKind.UnaryModel:
Emit("        IT_ModelType_? IT_EntityName_.T_UnaryModelFieldName_ => field_T_UnaryModelFieldName_;");
                                break;
                            case FieldKind.ArrayModel:
Emit("        IReadOnlyList<IT_ModelType_?>? IT_EntityName_.T_ArrayModelFieldName_ => field_T_ArrayModelFieldName_;");
                                break;
                            case FieldKind.IndexModel:
Emit("        IReadOnlyDictionary<T_IndexType_, IT_ModelType_?>? IT_EntityName_.T_IndexModelFieldName_");
Emit("            => field_T_IndexModelFieldName_ is null ? null");
Emit("            : new DictionaryFacade<T_IndexType_, IT_ModelType_?, T_ModelType_?>(field_T_IndexModelFieldName_, (x) => x);");
                                break;
                            case FieldKind.UnaryMaybe:
Emit("        T_ExternalOtherType_? IT_EntityName_.T_UnaryMaybeFieldName_ => field_T_UnaryMaybeFieldName_.ToExternal();");
                                break;
                            case FieldKind.ArrayMaybe:
Emit("        IReadOnlyList<T_ExternalOtherType_?>? IT_EntityName_.T_ArrayMaybeFieldName_");
Emit("            => field_T_ArrayMaybeFieldName_ is null ? null");
Emit("            : new ListFacade<T_ExternalOtherType_?, T_ConcreteOtherType_?>(field_T_ArrayMaybeFieldName_, (x) => x.ToExternal());");
                                break;
                            case FieldKind.IndexMaybe:
Emit("        IReadOnlyDictionary<T_IndexType_, T_ExternalOtherType_?>? IT_EntityName_.T_IndexMaybeFieldName_");
Emit("            => field_T_IndexMaybeFieldName_ is null ? null");
Emit("            : new DictionaryFacade<T_IndexType_, T_ExternalOtherType_?, T_ConcreteOtherType_?>(field_T_IndexMaybeFieldName_, (x) => x.ToExternal());");
                                break;
                            case FieldKind.UnaryOther:
Emit("        T_ExternalOtherType_ IT_EntityName_.T_UnaryOtherFieldName_ => field_T_UnaryOtherFieldName_.ToExternal();");
                                break;
                            case FieldKind.ArrayOther:
Emit("        IReadOnlyList<T_ExternalOtherType_>? IT_EntityName_.T_ArrayOtherFieldName_");
Emit("            => field_T_ArrayOtherFieldName_ is null ? null");
Emit("            : new ListFacade<T_ExternalOtherType_, T_ConcreteOtherType_>(field_T_ArrayOtherFieldName_, (x) => x.ToExternal());");
                                break;
                            case FieldKind.IndexOther:
Emit("        IReadOnlyDictionary<T_IndexType_, T_ExternalOtherType_>? IT_EntityName_.T_IndexOtherFieldName_");
Emit("            => field_T_IndexOtherFieldName_ is null ? null");
Emit("            : new DictionaryFacade<T_IndexType_, T_ExternalOtherType_, T_ConcreteOtherType_>(field_T_IndexOtherFieldName_, (x) => x.ToExternal());");
                                break;
                            case FieldKind.UnaryBuffer:
Emit("        Octets? IT_EntityName_.T_UnaryBufferFieldName_ => field_T_UnaryBufferFieldName_;");
                                break;
                            case FieldKind.ArrayBuffer:
Emit("        IReadOnlyList<Octets?>? IT_EntityName_.T_ArrayBufferFieldName_ => field_T_ArrayBufferFieldName_ is null");
Emit("            ? null");
Emit("            : new ListFacade<Octets, BinaryValue>(field_T_ArrayBufferFieldName_, x => (Octets?)x);");
                                break;
                            case FieldKind.IndexBuffer:
Emit("        IReadOnlyDictionary<T_IndexType_, Octets?>? IT_EntityName_.T_IndexBufferFieldName_ => field_T_IndexBufferFieldName_ is null");
Emit("            ? null");
Emit("            : new DictionaryFacade<T_IndexType_, Octets?, BinaryValue?>(field_T_IndexBufferFieldName_, x => (Octets?)x);");
                                break;
                            case FieldKind.UnaryString:
Emit("        String? IT_EntityName_.T_UnaryStringFieldName_ => field_T_UnaryStringFieldName_;");
                                break;
                            case FieldKind.ArrayString:
Emit("        IReadOnlyList<String?>? IT_EntityName_.T_ArrayStringFieldName_ => field_T_ArrayStringFieldName_;");
                                break;
                            case FieldKind.IndexString:
Emit("        IReadOnlyDictionary<T_IndexType_, String?>? IT_EntityName_.T_IndexStringFieldName_ => field_T_IndexStringFieldName_;");
                                break;
                            default: break;
                        }
                    }
                }
Emit("");
Emit("        [MethodImpl(MethodImplOptions.AggressiveInlining)]");
Emit("        public T_EntityName_()");
Emit("        {");
Emit("        }");
Emit("");
Emit("        [MethodImpl(MethodImplOptions.AggressiveInlining)]");
Emit("        public T_EntityName_(T_EntityName_ source) : base(source)");
Emit("        {");
                    foreach (var fd in cd.FieldDefs)
                    {
                        using (NewScope(fd))
                        {
                            var fieldInfo = new FieldInfo(fd, _engine.Current);
                            switch (fieldInfo.Kind)
                            {
                                case FieldKind.UnaryModel:
Emit("            field_T_UnaryModelFieldName_ = source.field_T_UnaryModelFieldName_;");
                                    break;
                                case FieldKind.ArrayModel:
Emit("            field_T_ArrayModelFieldName_ = source.field_T_ArrayModelFieldName_;");
                                    break;
                                case FieldKind.IndexModel:
Emit("            field_T_IndexModelFieldName_ = source.field_T_IndexModelFieldName_;");
                                    break;
                                case FieldKind.UnaryMaybe:
Emit("            field_T_UnaryMaybeFieldName_ = source.field_T_UnaryMaybeFieldName_;");
                                    break;
                                case FieldKind.ArrayMaybe:
Emit("            field_T_ArrayMaybeFieldName_ = source.field_T_ArrayMaybeFieldName_;");
                                    break;
                                case FieldKind.IndexMaybe:
Emit("            field_T_IndexMaybeFieldName_ = source.field_T_IndexMaybeFieldName_;");
                                    break;
                                case FieldKind.UnaryOther:
Emit("            field_T_UnaryOtherFieldName_ = source.field_T_UnaryOtherFieldName_;");
                                    break;
                                case FieldKind.ArrayOther:
Emit("            field_T_ArrayOtherFieldName_ = source.field_T_ArrayOtherFieldName_;");
                                    break;
                                case FieldKind.IndexOther:
Emit("            field_T_IndexOtherFieldName_ = source.field_T_IndexOtherFieldName_;");
                                    break;
                                case FieldKind.UnaryBuffer:
Emit("            field_T_UnaryBufferFieldName_ = source.field_T_UnaryBufferFieldName_;");
                                    break;
                                case FieldKind.ArrayBuffer:
Emit("            field_T_ArrayBufferFieldName_ = source.field_T_ArrayBufferFieldName_;");
                                    break;
                                case FieldKind.IndexBuffer:
Emit("            field_T_IndexBufferFieldName_ = source.field_T_IndexBufferFieldName_;");
                                    break;
                                case FieldKind.UnaryString:
Emit("            field_T_UnaryStringFieldName_ = source.field_T_UnaryStringFieldName_;");
                                    break;
                                case FieldKind.ArrayString:
Emit("            field_T_ArrayStringFieldName_ = source.field_T_ArrayStringFieldName_;");
                                    break;
                                case FieldKind.IndexString:
Emit("            field_T_IndexStringFieldName_ = source.field_T_IndexStringFieldName_;");
                                    break;
                                default: break;
                            }
                        }
                    }
Emit("        }");
Emit("");
Emit("        public void CopyFrom(T_EntityName_ source)");
Emit("        {");
Emit("            base.CopyFrom(source);");
                    foreach (var fd in cd.FieldDefs)
                    {
                        using (NewScope(fd))
                        {
                            var fieldInfo = new FieldInfo(fd, _engine.Current);
                            switch (fieldInfo.Kind)
                            {
                                case FieldKind.UnaryModel:
Emit("            field_T_UnaryModelFieldName_ = source.field_T_UnaryModelFieldName_;");
                                    break;
                                case FieldKind.ArrayModel:
Emit("            field_T_ArrayModelFieldName_ = source.field_T_ArrayModelFieldName_;");
                                    break;
                                case FieldKind.IndexModel:
Emit("            field_T_IndexModelFieldName_ = source.field_T_IndexModelFieldName_;");
                                    break;
                                case FieldKind.UnaryMaybe:
Emit("            field_T_UnaryMaybeFieldName_ = source.field_T_UnaryMaybeFieldName_;");
                                    break;
                                case FieldKind.ArrayMaybe:
Emit("            field_T_ArrayMaybeFieldName_ = source.field_T_ArrayMaybeFieldName_;");
                                    break;
                                case FieldKind.IndexMaybe:
Emit("            field_T_IndexMaybeFieldName_ = source.field_T_IndexMaybeFieldName_;");
                                    break;
                                case FieldKind.UnaryOther:
Emit("            field_T_UnaryOtherFieldName_ = source.field_T_UnaryOtherFieldName_;");
                                    break;
                                case FieldKind.ArrayOther:
Emit("            field_T_ArrayOtherFieldName_ = source.field_T_ArrayOtherFieldName_;");
                                    break;
                                case FieldKind.IndexOther:
Emit("            field_T_IndexOtherFieldName_ = source.field_T_IndexOtherFieldName_;");
                                    break;
                                case FieldKind.UnaryBuffer:
Emit("            field_T_UnaryBufferFieldName_ = source.field_T_UnaryBufferFieldName_;");
                                    break;
                                case FieldKind.ArrayBuffer:
Emit("            field_T_ArrayBufferFieldName_ = source.field_T_ArrayBufferFieldName_;");
                                    break;
                                case FieldKind.IndexBuffer:
Emit("            field_T_IndexBufferFieldName_ = source.field_T_IndexBufferFieldName_;");
                                    break;
                                case FieldKind.UnaryString:
Emit("            field_T_UnaryStringFieldName_ = source.field_T_UnaryStringFieldName_;");
                                    break;
                                case FieldKind.ArrayString:
Emit("            field_T_ArrayStringFieldName_ = source.field_T_ArrayStringFieldName_;");
                                    break;
                                case FieldKind.IndexString:
Emit("            field_T_IndexStringFieldName_ = source.field_T_IndexStringFieldName_;");
                                    break;
                                default: break;
                            }
                        }
                    }
Emit("        }");
Emit("");
Emit("        [MethodImpl(MethodImplOptions.AggressiveInlining)]");
Emit("        public T_EntityName_(IT_EntityName_ source) : base(source)");
Emit("        {");
                    foreach (var fd in cd.FieldDefs)
                    {
                        using (NewScope(fd))
                        {
                            var fieldInfo = new FieldInfo(fd, _engine.Current);
                            switch (fieldInfo.Kind)
                            {
                                case FieldKind.UnaryModel:
Emit("            field_T_UnaryModelFieldName_ = T_ModelType_.CreateFrom(source.T_UnaryModelFieldName_);");
                                    break;
                                case FieldKind.ArrayModel:
Emit("            field_T_ArrayModelFieldName_ = source.T_ArrayModelFieldName_ is null");
Emit("                ? null");
Emit("                : ImmutableList<T_ModelType_?>.Empty.AddRange(source.T_ArrayModelFieldName_.Select(x => T_ModelType_.CreateFrom(x)));");
                                    break;
                                case FieldKind.IndexModel:
Emit("            field_T_IndexModelFieldName_ = source.T_IndexModelFieldName_ is null");
Emit("                ? null");
Emit("                : ImmutableDictionary<T_IndexType_, T_ModelType_?>.Empty.AddRange(source.T_IndexModelFieldName_.Select(");
Emit("                    kvp => new KeyValuePair<T_IndexType_, T_ModelType_?>(kvp.Key, T_ModelType_.CreateFrom(kvp.Value))));");
                                    break;
                                case FieldKind.UnaryMaybe:
Emit("            field_T_UnaryMaybeFieldName_ = source.T_UnaryMaybeFieldName_.ToInternal();");
                                    break;
                                case FieldKind.ArrayMaybe:
Emit("            field_T_ArrayMaybeFieldName_ = source.T_ArrayMaybeFieldName_ is null");
Emit("                ? null");
Emit("                : ImmutableList<T_ConcreteOtherType_?>.Empty.AddRange(source.T_ArrayMaybeFieldName_.Select(x => x.ToInternal()));");
                                    break;
                                case FieldKind.IndexMaybe:
Emit("            field_T_IndexMaybeFieldName_ = source.T_IndexMaybeFieldName_ is null");
Emit("                ? null");
Emit("                : ImmutableDictionary<T_IndexType_, T_ConcreteOtherType_?>.Empty.AddRange(source.T_IndexMaybeFieldName_.Select(");
Emit("                    kvp => new KeyValuePair<T_IndexType_, T_ConcreteOtherType_?>(kvp.Key, kvp.Value.ToInternal())));");
                                    break;
                                case FieldKind.UnaryOther:
Emit("            field_T_UnaryOtherFieldName_ = source.T_UnaryOtherFieldName_.ToInternal();");
                                    break;
                                case FieldKind.ArrayOther:
Emit("            field_T_ArrayOtherFieldName_ = source.T_ArrayOtherFieldName_ is null");
Emit("                ? null");
Emit("                : ImmutableList<T_ConcreteOtherType_>.Empty.AddRange(source.T_ArrayOtherFieldName_.Select(x => x.ToInternal()));");
                                    break;
                                case FieldKind.IndexOther:
Emit("            field_T_IndexOtherFieldName_ = source.T_IndexOtherFieldName_ is null");
Emit("                ? null");
Emit("                : ImmutableDictionary<T_IndexType_, T_ConcreteOtherType_>.Empty.AddRange(source.T_IndexOtherFieldName_.Select(");
Emit("                    kvp => new KeyValuePair<T_IndexType_, T_ConcreteOtherType_>(kvp.Key, kvp.Value.ToInternal())));");
                                    break;
                                case FieldKind.UnaryBuffer:
Emit("            field_T_UnaryBufferFieldName_ = source.T_UnaryBufferFieldName_;");
                                    break;
                                case FieldKind.ArrayBuffer:
Emit("            field_T_ArrayBufferFieldName_ = source.T_ArrayBufferFieldName_ is null");
Emit("                ? null");
Emit("                : ImmutableList<BinaryValue?>.Empty.AddRange(source.T_ArrayBufferFieldName_.Select(x => (BinaryValue?)x));");
                                    break;
                                case FieldKind.IndexBuffer:
Emit("            field_T_IndexBufferFieldName_ = source.T_IndexBufferFieldName_ is null");
Emit("                ? null");
Emit("                : ImmutableDictionary<T_IndexType_, BinaryValue?>.Empty.AddRange(");
Emit("                    source.T_IndexBufferFieldName_.Select(kvp => new KeyValuePair<T_IndexType_, BinaryValue?>(kvp.Key, kvp.Value)));");
                                    break;
                                case FieldKind.UnaryString:
Emit("            field_T_UnaryStringFieldName_ = source.T_UnaryStringFieldName_;");
                                    break;
                                case FieldKind.ArrayString:
Emit("            field_T_ArrayStringFieldName_ = source.T_ArrayStringFieldName_ is null");
Emit("                ? null");
Emit("                : ImmutableList<String?>.Empty.AddRange(source.T_ArrayStringFieldName_);");
                                    break;
                                case FieldKind.IndexString:
Emit("            field_T_IndexStringFieldName_ = source.T_IndexStringFieldName_ is null");
Emit("                ? null");
Emit("                : ImmutableDictionary<T_IndexType_, String?>.Empty.AddRange(source.T_IndexStringFieldName_);");
                                    break;
                                default: break;
                            }
                        }
                    }
Emit("        }");
Emit("");
Emit("        public bool Equals(T_EntityName_? other)");
Emit("        {");
Emit("            if (other is null) return false;");
Emit("            if (ReferenceEquals(other, this)) return true;");
                    foreach (var fd in cd.FieldDefs)
                    {
                        using (NewScope(fd))
                        {
                            var fieldInfo = new FieldInfo(fd, _engine.Current);
                            switch (fieldInfo.Kind)
                            {
                                case FieldKind.UnaryModel:
Emit("            if (!field_T_UnaryModelFieldName_.ValueEquals(other.field_T_UnaryModelFieldName_)) return false;");
                                    break;
                                case FieldKind.ArrayModel:
Emit("            if (!field_T_ArrayModelFieldName_.ArrayEquals(other.field_T_ArrayModelFieldName_)) return false;");
                                    break;
                                case FieldKind.IndexModel:
Emit("            if (!field_T_IndexModelFieldName_.IndexEquals(other.field_T_IndexModelFieldName_)) return false;");
                                    break;
                                case FieldKind.UnaryMaybe:
Emit("            if (!field_T_UnaryMaybeFieldName_.ValueEquals(other.field_T_UnaryMaybeFieldName_)) return false;");
                                    break;
                                case FieldKind.ArrayMaybe:
Emit("            if (!field_T_ArrayMaybeFieldName_.ArrayEquals(other.field_T_ArrayMaybeFieldName_)) return false;");
                                    break;
                                case FieldKind.IndexMaybe:
Emit("            if (!field_T_IndexMaybeFieldName_.IndexEquals(other.field_T_IndexMaybeFieldName_)) return false;");
                                    break;
                                case FieldKind.UnaryOther:
Emit("            if (!field_T_UnaryOtherFieldName_.ValueEquals(other.field_T_UnaryOtherFieldName_)) return false;");
                                    break;
                                case FieldKind.ArrayOther:
Emit("            if (!field_T_ArrayOtherFieldName_.ArrayEquals(other.field_T_ArrayOtherFieldName_)) return false;");
                                    break;
                                case FieldKind.IndexOther:
Emit("            if (!field_T_IndexOtherFieldName_.IndexEquals(other.field_T_IndexOtherFieldName_)) return false;");
                                    break;
                                case FieldKind.UnaryBuffer:
Emit("            if (!field_T_UnaryBufferFieldName_.ValueEquals(other.field_T_UnaryBufferFieldName_)) return false;");
                                    break;
                                case FieldKind.ArrayBuffer:
Emit("            if (!field_T_ArrayBufferFieldName_.ArrayEquals(other.field_T_ArrayBufferFieldName_)) return false;");
                                    break;
                                case FieldKind.IndexBuffer:
Emit("            if (!field_T_IndexBufferFieldName_.IndexEquals(other.field_T_IndexBufferFieldName_)) return false;");
                                    break;
                                case FieldKind.UnaryString:
Emit("            if (!field_T_UnaryStringFieldName_.ValueEquals(other.field_T_UnaryStringFieldName_)) return false;");
                                    break;
                                case FieldKind.ArrayString:
Emit("            if (!field_T_ArrayStringFieldName_.ArrayEquals(other.field_T_ArrayStringFieldName_)) return false;");
                                    break;
                                case FieldKind.IndexString:
Emit("            if (!field_T_IndexStringFieldName_.IndexEquals(other.field_T_IndexStringFieldName_)) return false;");
                                    break;
                                default: break;
                            }
                        }
                    }
Emit("            return base.Equals(other);");
Emit("        }");
Emit("");
Emit("        [MethodImpl(MethodImplOptions.AggressiveInlining)]");
Emit("        public static bool operator ==(T_EntityName_ left, T_EntityName_ right)");
Emit("        {");
Emit("            if (left is null) return (right is null);");
Emit("            return left.Equals(right);");
Emit("        }");
Emit("");
Emit("        [MethodImpl(MethodImplOptions.AggressiveInlining)]");
Emit("        public static bool operator !=(T_EntityName_ left, T_EntityName_ right)");
Emit("        {");
Emit("            if (left is null) return !(right is null);");
Emit("            return !left.Equals(right);");
Emit("        }");
Emit("");
Emit("        [MethodImpl(MethodImplOptions.AggressiveInlining)]");
Emit("        public override bool Equals(object? obj)");
Emit("        {");
Emit("            return obj is T_EntityName_ other && Equals(other);");
Emit("        }");
Emit("");
Emit("        private int CalcHashCode()");
Emit("        {");
Emit("            HashCode hc = new HashCode();");
                    foreach (var fd in cd.FieldDefs)
                    {
                        using (NewScope(fd))
                        {
                            var fieldInfo = new FieldInfo(fd, _engine.Current);
                            switch (fieldInfo.Kind)
                            {
                                case FieldKind.UnaryModel:
Emit("            hc.Add(field_T_UnaryModelFieldName_.CalcHashUnary());");
                                    break;
                                case FieldKind.ArrayModel:
Emit("            hc.Add(field_T_ArrayModelFieldName_.CalcHashArray());");
                                    break;
                                case FieldKind.IndexModel:
Emit("            hc.Add(field_T_IndexModelFieldName_.CalcHashIndex());");
                                    break;
                                case FieldKind.UnaryMaybe:
Emit("            hc.Add(field_T_UnaryMaybeFieldName_.CalcHashUnary());");
                                    break;
                                case FieldKind.ArrayMaybe:
Emit("            hc.Add(field_T_ArrayMaybeFieldName_.CalcHashArray());");
                                    break;
                                case FieldKind.IndexMaybe:
Emit("            hc.Add(field_T_IndexMaybeFieldName_.CalcHashIndex());");
                                    break;
                                case FieldKind.UnaryOther:
Emit("            hc.Add(field_T_UnaryOtherFieldName_.CalcHashUnary());");
                                    break;
                                case FieldKind.ArrayOther:
Emit("            hc.Add(field_T_ArrayOtherFieldName_.CalcHashArray());");
                                    break;
                                case FieldKind.IndexOther:
Emit("            hc.Add(field_T_IndexOtherFieldName_.CalcHashIndex());");
                                    break;
                                case FieldKind.UnaryBuffer:
Emit("            hc.Add(field_T_UnaryBufferFieldName_.CalcHashUnary());");
                                    break;
                                case FieldKind.ArrayBuffer:
Emit("            hc.Add(field_T_ArrayBufferFieldName_.CalcHashArray());");
                                    break;
                                case FieldKind.IndexBuffer:
Emit("            hc.Add(field_T_IndexBufferFieldName_.CalcHashIndex());");
                                    break;
                                case FieldKind.UnaryString:
Emit("            hc.Add(field_T_UnaryStringFieldName_.CalcHashUnary());");
                                    break;
                                case FieldKind.ArrayString:
Emit("            hc.Add(field_T_ArrayStringFieldName_.CalcHashArray());");
                                    break;
                                case FieldKind.IndexString:
Emit("            hc.Add(field_T_IndexStringFieldName_.CalcHashIndex());");
                                    break;
                                default: break;
                            }
                        }
                    }
Emit("            hc.Add(base.GetHashCode());");
Emit("            return hc.ToHashCode();");
Emit("        }");
Emit("");
Emit("        private int? _hashCode = null;");
Emit("        public override int GetHashCode()");
Emit("        {");
Emit("            if (_hashCode is null)");
Emit("                _hashCode = CalcHashCode();");
Emit("            return _hashCode.Value;");
Emit("        }");
Emit("");
Emit("    }");
Emit("");
        }
    }
Emit("");
Emit("}");
// |metacode:generator_footer|
        }
    }
}
// |metacode:generator_end|
